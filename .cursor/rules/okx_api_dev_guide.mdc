---
description: 
globs: 
alwaysApply: false
---
# OKX API Guide

## Overview

This guide consolidates information about accessing OKX market data via its REST API and historical data via CDN, with a focus on integration into a data system.

## Endpoints

OKX provides market data through REST API endpoints:

- **Primary API Endpoint**: `https://www.okx.com/api/v5`
- **Candles Endpoint**: `/market/candles` - For recent candlestick data
- **Historical Candles Endpoint**: `/market/history-candles` - For historical candlestick data

## Market Types

OKX offers several market types; our integration focuses on the following:

1.  **SPOT**: Trading pairs like `BTC-USDT`. Symbols use a hyphenated format.
2.  **SWAP (FUTURES_USDT)**: Perpetual contracts like `BTC-USD-SWAP`. Symbols use a hyphenated format with a `-USD-SWAP` suffix.
3.  **FUTURES**: Futures contracts with settlement dates (e.g., `BTC-USD-240927`).

## Data Format

### Candle Data Structure
Candles data is returned as an array with the following structure. Note that all values are returned as strings:

```
[
  [
    "timestamp",       // Timestamp in milliseconds (string)
    "open",           // Open price (string)
    "high",           // High price (string)
    "low",            // Low price (string)
    "close",          // Close price (string)
    "volume",         // Trade volume (string)
    "volCcy",         // Volume in currency (string)
    "volCcyQuote",    // Volume in quote currency (string)
    "confirm"         // Whether this candle is confirmed (string, "0" or "1")
  ],
  ...
]
```

### Historical Trade Data (via CDN)

OKX provides historical trade and aggregate trade data via a CDN with an Alibaba OSS backend. Data is organized hierarchically by type (`trades`/`aggtrades`), then daily (`daily/YYYYMMDD`).

#### URL Patterns:

-   Trades: `https://www.okx.com/cdn/okex/traderecords/trades/daily/{YYYYMMDD}/{SYMBOL}-trades-{YYYY-MM-DD}.zip`
-   Aggregate Trades: `https://www.okx.com/cdn/okex/traderecords/aggtrades/daily/{YYYYMMDD}/{SYMBOL}-aggtrades-{YYYY-MM-DD}.zip`

#### Data Format (CSV within ZIP):

Both trade and aggregate trade data contain the following fields:

-   `trade_id`
-   `side`
-   `size`
-   `price`
-   `created_time` (Unix timestamp in milliseconds)

## Supported Intervals

OKX supports the following intervals for candle data:

- `1m`: 1 minute
- `3m`: 3 minutes
- `5m`: 5 minutes
- `15m`: 15 minutes
- `30m`: 30 minutes
- `1H`: 1 hour
- `2H`: 2 hour
- `4H`: 4 hour
- `6H`: 6 hour
- `12H`: 12 hour
- `1D`: 1 day
- `1W`: 1 week
- `1M`: 1 month

**Note**: OKX uses capital letters for hour, day, week, and month intervals (e.g., `1H` instead of `1h`), which differs from Binance's notation.

## Symbol Format

OKX uses hyphenated symbols, unlike Binance which concatenates base and quote currencies.

### Symbol Transformation Rules (for integration)

-   **SPOT**: Convert from `BTCUSDT` to `BTC-USDT`
-   **FUTURES_USDT (SWAP)**: Convert from `BTCUSDT` to `BTC-USD-SWAP`

## Request Parameters

### Candles Endpoint
- **instId** (required): Instrument ID, e.g., `BTC-USDT` for SPOT, `BTC-USD-SWAP` for swaps
- **bar** (optional): Bar size, default is `1m`. Supported intervals:
  - `1m`: 1 minute
  - `3m`: 3 minutes
  - `5m`: 5 minutes
  - `15m`: 15 minutes
  - `30m`: 30 minutes
  - `1H`: 1 hour
  - `2H`: 2 hour
  - `4H`: 4 hour
  - `6H`: 6 hour
  - `12H`: 12 hour
  - `1D`: 1 day
  - `1W`: 1 week
  - `1M`: 1 month
- **limit** (optional): Number of results per request, default is 100, maximum is 300
- **before** (optional): Pagination of data to retrieve candles before (newer than) requested timestamp
- **after** (optional): Pagination of data to retrieve candles after (older than) requested timestamp

### History Candles Endpoint
Same parameters as the Candles endpoint, but is used for historical data.

## Usage Examples

### Get recent BTC-USDT 1-minute candles:
```bash
curl -X GET "https://www.okx.com/api/v5/market/candles?instId=BTC-USDT&bar=1m&limit=100"
```

### Get historical BTC-USDT daily candles:
```bash
curl -X GET "https://www.okx.com/api/v5/market/history-candles?instId=BTC-USDT&bar=1D&limit=100&after=1715113200000"
```

## Integration Details

### Data Provider Enum

OKX is added as a data provider enum alongside BINANCE and TRADESTATION:

```python
class DataProvider(Enum):
    BINANCE = auto()
    TRADESTATION = auto()
    OKX = auto()
```

### Market Capabilities

OKX market capabilities are defined for SPOT and FUTURES_USDT markets with:

-   Maximum limit of 300 records per request for API data.
-   Support for all candle intervals except 1-second.
-   Appropriate symbol format examples.

### Symbol Validation

Symbol validation enforces:

-   Hyphenated format for all OKX symbols.
-   `-SWAP` suffix for FUTURES_USDT markets.

## Testing

Our integration testing confirms:

1.  OKX API endpoints for both recent and historical data are working correctly.
2.  Symbol formatting and validation logic works as expected.
3.  All supported intervals are available and return data.
4.  Maximum limit of 300 records is enforced.

## Limitations

-   Maximum of 300 records per request for API data (compared to 1000 for Binance).
-   No support for 1-second interval data via API.
-   Rate limits apply to API requests but are not explicitly documented.
-   Historical candle data availability may vary by instrument.
-   No directory listing on the CDN for historical trade data.
-   No API for discovering available historical trade data on the CDN.
-   Date range availability for historical trade data is not explicitly documented.
-   No dedicated data-only endpoint like Binance Vision.
-   No officially documented backup endpoints.
